---
title: "10x Genomics scATAC-seq QC"
author: 
 - Lucas Graybuck
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    self_contained: true
params:
  in_pre: NULL
  in_sin: NULL
  in_sum: NULL
  in_key: NULL
  in_well: NULL
  out_dir: NULL
---

<a id="contents"></a>

## Contents

#### [Data Processing](#data_processing)
- [Session Preparation](#session_preparation)
- [Load Inputs](#load_inputs)
- [Assemble Metadata](#assemble data)
- [Fragment Output](#data_output)

#### [QC Metrics and Plots](#qc_metrics)
- [Well-Based QC](#well_qc)
- [10x Genomics Metrics](#well_metrics)
- [Read/UMI/Gene Stats](#rug_stats)
- [Read/UMI/Gene Histograms](#rug_hists)
- [Read/UMI/Gene Scatters](#rug_scatters)
- [Write QC JSON](#json_out)

#### [Session Info](#session_info)

<a id="data_processing"></a>

## Data Processing

<a id="session_preparation"></a>

### Session Preparation

#### Load libraries:
```{r Load Libraries}
start_time <- Sys.time()

quiet_library <- function(...) {
  suppressPackageStartupMessages(library(...))
}
quiet_library(rhdf5)
quiet_library(ATAComb)
quiet_library(H5weaver)
quiet_library(Matrix)
quiet_library(S4Vectors)
quiet_library(ggplot2)
quiet_library(cowplot)
quiet_library(jsonlite)
```

Declaring start
```{r Declare start}
stm("Starting scATAC-seq preprocessing")
```

#### Argument parsing
```{r Parse arguments}
if(is.null(params$in_pre)) {
  in_pre <- system.file("testdata/preprocessed", package = "ATAComb")
  in_sin <- system.file("testdata/outs/singlecell.csv", package = "ATAComb")
  in_sum <- system.file("testdata/outs/summary.csv", package = "ATAComb")
  in_key <- system.file("testdata/test_SampleSheet.csv", package = "ATAComb")
  in_well <- "B000-AP0C1W1"
  out_dir <- tempdir()
} else {
  in_pre <- params$in_pre
  in_sin <- params$in_sin
  in_sum <- params$in_sum
  in_key <- params$in_key
  in_well <- params$in_well
  out_dir <- params$out_dir
}

in_well <- sub("-[AHR]?P","-AP",in_well)

# Check Well ID format
if(!grepl("^[A-Z][0-9]{3}-AP[0-9]C[0-9]W[0-9]$", in_well)) {
  stm(paste0("ERROR: Input Well ID is not in expected format, e.g. B###-AP#C#W# :", in_h5))
  stop()
}

stm(paste0("IN  preprocessed dir : ", in_pre))
stm(paste0("IN  singlecell.csv   : ", in_sin))
stm(paste0("IN  summary.csv      : ", in_sum))
stm(paste0("IN  SampleSheet      : ", in_key))
stm(paste0("IN  Well ID          : ", in_well))
stm(paste0("OUT Directory        : ", out_dir))
```

#### Input Parameters
```{r Print Arguments}
print(c(
  paste0("IN  preprocessed dir : ", in_pre),
  paste0("IN  singlecell.csv   : ", in_sin),
  paste0("IN  summary.csv      : ", in_sum),
  paste0("IN  SampleSheet      : ", in_key),
  paste0("IN  Well ID          : ", in_well),
  paste0("OUT H5 directory     : ", out_dir)
))
```

#### Check Input Files
```{r Check Inputs}
if(!dir.exists(in_pre)) {
  stm(paste0("ERROR: Cannot find IN preprocessed dir:", in_pre))
  stop()
}
if(!file.exists(in_sin)) {
  stm(paste0("ERROR: Cannot find IN singlecell.csv:", in_sin))
  stop()
}
if(!file.exists(in_sum)) {
  stm(paste0("ERROR: Cannot find IN summary.csv:", in_sum))
  stop()
}
if(!file.exists(in_key)) {
  stm(paste0("ERROR: Cannot find IN SampleSheet file:", in_key))
  stop()
}
```

#### Create out directory if missing
```{r Create Out Dir}
if(!dir.exists(out_dir)) {
  stm(paste0("Creating Output Directory: ",out_dir))
  dir.create(out_dir, 
             recursive = TRUE)
}
```

#### Declare QC Cutoffs
```{r}
fralt_cut <- 0.7
fritss_cut <- 0.2
frip_cut <- 0.2

stm("Using QC Cutoffs:")
stm(paste("QC FRAlt  : >",fralt_cut))
stm(paste("QC FRITSS : >",fritss_cut))
stm(paste("QC FRIP   : >",frip_cut))
```

```{r}
print(c(
  "Using QC Cutoffs:",
  paste("QC FRAlt  : >",fralt_cut),
  paste("QC FRITSS : >",fritss_cut),
  paste("QC FRIP   : >",frip_cut)
))
```

[Return to Contents](#contents)

<a id="load_inputs"></a>

### Load inputs

#### Load Reference Datasets
```{r Load references}
# Altius Index
alt_idx_file <- system.file("reference/hg38_alt_dhs_index.bed.gz", package = "ATAComb")
stm(paste("Reading Altius Index from", alt_idx_file))
alt_idx_bed <- fread(alt_idx_file)

# Buenrostro Peak Reference
peaks_file <- system.file("reference/hg38_GSE123577_filtered.bed.gz", package = "ATAComb")
stm(paste("Reading Peak Reference from", peaks_file))
peaks_bed <- fread(peaks_file)

# Gene Body Reference
gene_bodies_file <- system.file("reference/hg38_ensemble93_gene_bodies.bed.gz", package = "ATAComb")
stm(paste("Reading ENSEMBL Gene Body Reference from", gene_bodies_file))
gene_bodies_bed <- fread(gene_bodies_file)

# TSS Reference
tss_file <- system.file("reference/hg38_ensemble93_tss_2kb.bed.gz",package = "ATAComb")
stm(paste("Reading ENSEMBL TSS Reference from", tss_file))
tss_bed <- fread(tss_file)
```

#### Load SampleSheet
```{r Load SampleSheet}
stm(paste0("Reading SampleSheet from ", in_key))

samplesheet <- read.csv(in_key)
```


[Return to Contents](#contents)

<a id="assemble_data"></a>

### Generate Metadata

#### Read metadata sources
```{r}
stm(paste0("Reading 10x metadata from ", in_sin))

tenx_meta <- fread(in_sin)[-1,]
tenx_meta <- tenx_meta[, list(barcode, total, duplicate,mitochondrial , passed_filters)]
names(tenx_meta) <- c("original_barcodes","n_fragments","n_duplicate","n_mito","n_unique")

stm(paste0("Reading reference counts from ", in_pre))

alt_idx_counts <- fread(file.path(in_pre, "altius_total_counts.tsv.gz"), header = FALSE, col.names = c("original_barcodes","altius_count"))
peaks_counts <- fread(file.path(in_pre, "peaks_total_counts.tsv.gz"), header = FALSE, col.names = c("original_barcodes","peaks_count"))
tss_counts <- fread(file.path(in_pre, "tss_total_counts.tsv.gz"), header = FALSE, col.names = c("original_barcodes","tss_count"))
gene_bodies_counts <- fread(file.path(in_pre, "gene_bodies_total_counts.tsv.gz"), header = FALSE, col.names = c("original_barcodes","gene_bodies_count"))

meta <- tenx_meta[alt_idx_counts, on = "original_barcodes"]
meta <- meta[peaks_counts, on = "original_barcodes"]
meta <- meta[tss_counts, on = "original_barcodes"]
meta <- meta[gene_bodies_counts, on = "original_barcodes"]
```


#### Filter metadata based on cutoffs
```{r}
stm("Filtering based on QC cutoffs")

meta$fralt <- meta$altius_count / meta$n_unique
meta$frip <- meta$peaks_count / meta$n_unique
meta$fritss <- meta$tss_count / meta$n_unique
filtered_meta <- meta[fralt > fralt_cut & 
                        frip > frip_cut &
                        fritss > fritss_cut,]
```


#### Generate cell IDs
```{r Generate IDs}
stm("Generating Cell IDs")

filtered_meta$barcodes <- ids::uuid(nrow(filtered_meta),
                                    drop_hyphens = TRUE, 
                                    use_time = TRUE)
filtered_meta$cell_name <- ids::adjective_animal(nrow(filtered_meta),
                                                 n_adjectives = 2,
                                                 max_len = 10)
```

#### Add Well/Chip/Pool/Sample IDs
```{r}
stm("Adding Batch and Sample ID metadata")
filtered_meta$well_id <- in_well
filtered_meta$chip_id <- sub("W[0-9]+$","",filtered_meta$well_id)
filtered_meta$batch_id <- sub("-.+","",filtered_meta$chip_id)
filtered_meta$pbmc_sample_id <- as.character(samplesheet$SampleID[samplesheet$WellID == in_well])
```

[Return to Contents](#contents)

<a id="mats"></a>

## Compute Feature Matrices

<a id="mats_alt"></a>

#### Read overlaps with Altius index
```{r Altius overlaps}
stm("Building Altius Index matrix")

alt_dt <- fread(file.path(in_pre, "altius_sparse_matrix.tsv.gz"),
                header = FALSE,
                col.names = c("original_barcodes",
                              "i",
                              "x"),
                colClasses = list("character" = 1,
                                  "integer" = c(2,3)))

alt_dt <- alt_dt[original_barcodes %in% filtered_meta$original_barcodes]
```

#### Build Altius list
```{r Build Altius h5}
barcode_counts <- table(alt_dt$original_barcodes)
region_names <- paste(alt_idx_bed$V1,
                      alt_idx_bed$V2,
                      alt_idx_bed$V3,
                      sep = "_")
alt_list <- list(matrix = list(barcodes = names(barcode_counts),
                               data = alt_dt$x,
                               indices = alt_dt$i,
                               indptr = c(0, unname(cumsum(barcode_counts))),
                               shape = c(nrow(alt_idx_bed),
                                         nrow(filtered_meta)),
                               features = list(name = region_names,
                                               id = alt_idx_bed$V4)))
rm(alt_dt)

alt_list$matrix$observations <- as.list(filtered_meta)
```

Write Altius Index .h5 file
```{r Write Altius h5}
alt_out_file <- file.path(out_dir, paste0(in_well, "_altius.h5"))
stm(paste("Writing Altius Index h5 file to", alt_out_file))
write_h5_list(alt_list,
              alt_out_file)

rm(alt_list)
```

[Return to Contents](#contents)

<a id="mats_peaks"></a>

#### Read overlaps with Peaks reference
```{r Peak overlaps}
stm("Building Peak matrix")

peaks_dt <- fread(file.path(in_pre, "peaks_sparse_matrix.tsv.gz"),
                  header = FALSE,
                  col.names = c("original_barcodes",
                                "i",
                                "x"),
                  colClasses = list("character" = 1,
                                    "integer" = c(2,3)))

peaks_dt <- peaks_dt[original_barcodes %in% filtered_meta$original_barcodes]
```

#### Build Peaks list
```{r Build Peaks h5}
barcode_counts <- table(peaks_dt$original_barcodes)
region_names <- paste(peaks_bed$V1,
                      peaks_bed$V2,
                      peaks_bed$V3,
                      sep = "_")
peaks_list <- list(matrix = list(barcodes = names(barcode_counts),
                                 data = peaks_dt$x,
                                 indices = peaks_dt$i,
                                 indptr = c(0, unname(cumsum(barcode_counts))),
                                 shape = c(nrow(peaks_bed),
                                           nrow(filtered_meta)),
                                 features = list(name = region_names)))
rm(peaks_dt)

peaks_list$matrix$observations <- as.list(filtered_meta)
```

Write Peaks .h5 file
```{r Write Peaks h5}
peaks_out_file <- file.path(out_dir, paste0(in_well, "_peaks.h5"))
stm(paste("Writing peaks h5 file to", peaks_out_file))
write_h5_list(peaks_list,
              peaks_out_file)

rm(peaks_list)
```

[Return to Contents](#contents)

<a id="mats_tss"></a>

#### Read overlaps with TSS reference
```{r TSS overlaps}
stm("Building TSS matrix")

tss_dt <- fread(file.path(in_pre, "tss_sparse_matrix.tsv.gz"),
                header = FALSE,
                col.names = c("original_barcodes",
                              "i",
                              "x"),
                colClasses = list("character" = 1,
                                  "integer" = c(2,3)))

tss_dt <- tss_dt[original_barcodes %in% filtered_meta$original_barcodes]
```

#### Build TSSs list
```{r Build TSS h5}
barcode_counts <- table(tss_dt$original_barcodes)
region_names <- paste(tss_bed$V1,
                      tss_bed$V2,
                      tss_bed$V3,
                      sep = "_")
tss_list <- list(matrix = list(barcodes = names(barcode_counts),
                               data = tss_dt$x,
                               indices = tss_dt$i,
                               indptr = c(0, cumsum(barcode_counts)),
                               shape = c(nrow(tss_bed),
                                         nrow(filtered_meta)),
                               features = list(name = region_names)))
rm(tss_dt)

tss_list$matrix$observations <- as.list(filtered_meta)
```

Write TSSs .h5 file
```{r Write TSSs h5}
tss_out_file <- file.path(out_dir, paste0(in_well, "_tss.h5"))
stm(paste("Writing tss h5 file to", tss_out_file))
write_h5_list(tss_list,
              tss_out_file)

rm(tss_list)
```

[Return to Contents](#contents)

<a id="mats_gene_bodies"></a>

#### Read overlaps with Gene Bodies reference
```{r Gene Bodies overlaps}
stm("Building Gene Bodies matrix")

gene_bodies_dt <- fread(file.path(in_pre, "gene_bodies_sparse_matrix.tsv.gz"),
                        header = FALSE,
                        col.names = c("original_barcodes",
                                      "i",
                                      "x"),
                        colClasses = list("character" = 1,
                                          "integer" = c(2,3)))

gene_bodies_dt <- gene_bodies_dt[original_barcodes %in% filtered_meta$original_barcodes]
```

#### Build Gene Bodies list
```{r Build Gene Bodies h5}
barcode_counts <- table(gene_bodies_dt$original_barcodes)
region_names <- paste(gene_bodies_bed$V1,
                      gene_bodies_bed$V2,
                      gene_bodies_bed$V3,
                      sep = "_")
gene_bodies_list <- list(matrix = list(barcodes = names(barcode_counts),
                                       data = gene_bodies_dt$x,
                                       indices = gene_bodies_dt$i,
                                       indptr = c(0, cumsum(barcode_counts)),
                                       shape = c(nrow(gene_bodies_bed),
                                                 nrow(filtered_meta)),
                                       features = list(name = region_names)))
rm(gene_bodies_dt)

gene_bodies_list$matrix$observations <- as.list(filtered_meta)
```

Write Gene Bodies .h5 file
```{r Write Gene Bodies h5}
gene_bodies_out_file <- file.path(out_dir, paste0(in_well, "_gene_bodies.h5"))
stm(paste("Writing gene_bodies h5 file to", gene_bodies_out_file))
write_h5_list(gene_bodies_list,
              gene_bodies_out_file)

rm(gene_bodies_list)
```

[Return to Contents](#contents)

### Window count matrices

<a id="mats_5k"></a>

#### Read 5k window counts
```{r 5k Window Matrices}
window_5k_offsets <- read_chrom_sizes("hg38", window_size = 5e3)
window_5k_dt <- fread(file.path(in_pre, "window_5k_counts.tsv.gz"),
                       header = FALSE,
                       col.names = c("original_barcodes",
                                     "chr",
                                     "chr_i",
                                     "x"),
                       colClasses = list("character" = c(1,2),
                                         "integer" = c(3,4)))

window_5k_dt <- window_5k_dt[original_barcodes %in% filtered_meta$original_barcodes]

window_5k_dt <- window_5k_dt[window_5k_offsets, on = "chr"]
window_5k_dt$i <- window_5k_dt$chr_i + window_5k_dt$offset
```

#### Build 5k window list
```{r Build 5k Window h5}
region_bed <- window_index_to_bed(1:sum(window_5k_offsets$n_windows),
                                  window_5k_offsets,
                                  window_size = 5e3)
region_names <- paste(region_bed$chr, region_bed$start, region_bed$end, sep = "_")
barcode_counts <- table(window_5k_dt$original_barcodes)
window_5k_list <- list(matrix = list(barcodes = names(barcode_counts),
                                      data = window_5k_dt$x,
                                      indices = window_5k_dt$i,
                                      indptr = c(0, cumsum(barcode_counts)),
                                      shape = c(sum(window_5k_offsets$n_windows),
                                                nrow(filtered_meta)),
                                      features = list(name = region_names)))
rm(window_5k_dt)

window_5k_list$matrix$observations <- as.list(filtered_meta)
```

Write Gene Body .h5 file
```{r Write 5k Window h5}
window_5k_out_file <- file.path(out_dir, paste0(in_well, "_window_5k.h5"))
stm(paste("Writing 5k Window h5 file to", window_5k_out_file))
write_h5_list(window_5k_list,
              window_5k_out_file)

rm(window_5k_list)
```

[Return to Contents](#contents)

<a id="mats_20k"></a>

#### Read 20k window counts
```{r 20k Window Matrices}
window_20k_offsets <- read_chrom_sizes("hg38", window_size = 2e4)
window_20k_dt <- fread(file.path(in_pre, "window_20k_counts.tsv.gz"),
                       header = FALSE,
                       col.names = c("original_barcodes",
                                     "chr",
                                     "chr_i",
                                     "x"),
                       colClasses = list("character" = c(1,2),
                                         "integer" = c(3,4)))

window_20k_dt <- window_20k_dt[original_barcodes %in% filtered_meta$original_barcodes]

window_20k_dt <- window_20k_dt[window_20k_offsets, on = "chr"]
window_20k_dt$i <- window_20k_dt$chr_i + window_20k_dt$offset
```

#### Build 20k window list
```{r Build 20k Window h5}
region_bed <- window_index_to_bed(1:sum(window_20k_offsets$n_windows),
                                  window_20k_offsets,
                                  window_size = 2e4)
region_names <- paste(region_bed$chr, region_bed$start, region_bed$end, sep = "_")
barcode_counts <- table(window_20k_dt$original_barcodes)
window_20k_list <- list(matrix = list(barcodes = names(barcode_counts),
                                      data = window_20k_dt$x,
                                      indices = window_20k_dt$i,
                                      indptr = c(0, cumsum(barcode_counts)),
                                      shape = c(sum(window_20k_offsets$n_windows),
                                                nrow(filtered_meta)),
                                      features = list(name = region_names)))
rm(window_20k_dt)

window_20k_list$matrix$observations <- as.list(filtered_meta)
```

Write Gene Body .h5 file
```{r Write 20k Window h5}
window_20k_out_file <- file.path(out_dir, paste0(in_well, "_window_20k.h5"))
stm(paste("Writing 20k Window h5 file to", window_20k_out_file))
write_h5_list(window_20k_list,
              window_20k_out_file)

rm(window_20k_list)
```

[Return to Contents](#contents)

<a id="mats_100k"></a>

#### Read 100k window counts
```{r 100k Window Matrices}
window_100k_offsets <- read_chrom_sizes("hg38", window_size = 1e5)
window_100k_dt <- fread(file.path(in_pre, "window_100k_counts.tsv.gz"),
                       header = FALSE,
                       col.names = c("original_barcodes",
                                     "chr",
                                     "chr_i",
                                     "x"),
                       colClasses = list("character" = c(1,2),
                                         "integer" = c(3,4)))

window_100k_dt <- window_100k_dt[original_barcodes %in% filtered_meta$original_barcodes]

window_100k_dt <- window_100k_dt[window_100k_offsets, on = "chr"]
window_100k_dt$i <- window_100k_dt$chr_i + window_100k_dt$offset
```

#### Build 100k window list
```{r Build 100k Window h5}
region_bed <- window_index_to_bed(1:sum(window_100k_offsets$n_windows),
                                  window_100k_offsets,
                                  window_size = 1e5)
region_names <- paste(region_bed$chr, region_bed$start, region_bed$end, sep = "_")
barcode_counts <- table(window_100k_dt$original_barcodes)
window_100k_list <- list(matrix = list(barcodes = names(barcode_counts),
                                      data = window_100k_dt$x,
                                      indices = window_100k_dt$i,
                                      indptr = c(0, cumsum(barcode_counts)),
                                      shape = c(sum(window_100k_offsets$n_windows),
                                                nrow(filtered_meta)),
                                      features = list(name = region_names)))
rm(window_100k_dt)

window_100k_list$matrix$observations <- as.list(filtered_meta)
```

Write Gene Body .h5 file
```{r Write 100k Window h5}
window_100k_out_file <- file.path(out_dir, paste0(in_well, "_window_100k.h5"))
stm(paste("Writing 100k Window h5 file to", window_100k_out_file))
write_h5_list(window_100k_list,
              window_100k_out_file)

rm(window_100k_list)
```

[Return to Contents](#contents)

<a id="qc_stats"></a>

#### Barcode QC Stats
```{r}
barcode_conditions <- list("all" = rep(TRUE, nrow(meta)),
                           "pass_qc" = meta$fralt > fralt_cut & meta$frip > frip_cut & meta$fritss > fritss_cut,
                           "fail_qc" = meta$fralt < fralt_cut | meta$frip < frip_cut | meta$fritss < fritss_cut,
                           "fail_fralt" = meta$fralt < fralt_cut,
                           "fail_frip" = meta$frip < frip_cut,
                           "fail_fritss" = meta$fritss < fritss_cut,
                           "fail_all" = meta$fralt < fralt_cut & meta$frip < frip_cut & meta$fritss < fritss_cut)

perc_of <- function(x, d) {
  round(sum(x) / d * 100, 2)
}

q_of <- function(x, target, q) {
  vals <- target[x]
  round(quantile(vals, probs = q), 4)
}

barcode_qc_stats <- data.frame(metric = c("Barcodes with > 1k reads",
                                          "Barcodes pass QC",
                                          "Barcodes fail QC",
                                          "Barcodes fail FRAlt",
                                          "Barcodes fail FRIP",
                                          "Barcodes fail FRITSS",
                                          "Barcodes fail all"),
                               count = sapply(barcode_conditions, sum),
                               percent = sapply(barcode_conditions, perc_of, nrow(meta)),
                               median_fragments = sapply(barcode_conditions, q_of, meta$n_fragments, .50),
                               median_unique = sapply(barcode_conditions, q_of, meta$n_unique, .50),
                               median_fralt = sapply(barcode_conditions, q_of, meta$fralt, .50),
                               median_frip = sapply(barcode_conditions, q_of, meta$frip, .50),
                               median_fritss = sapply(barcode_conditions, q_of, meta$fritss, .50))

qc_table(barcode_qc_stats)
```

#### Read QC Stats
```{r}
metrics_summary <- read.csv(in_sum)

fragment_qc_stats <- data.frame(metric = c("Sequenced Fragments",
                                          "Mitochondrial Fragments",
                                          "Total in Barcodes with > 1k Reads",
                                          "Total in Barcodes passing QC",
                                          "Total in Barcodes failing QC",
                                          "Unique in Barcodes with > 1k Reads",
                                          "Unique in Barcodes passing QC",
                                          "Unique in Barcodes failing QC"),
                               count = c(metrics_summary$num_fragments,
                                         ceiling(metrics_summary$num_fragments * metrics_summary$frac_waste_mitochondrial),
                                         sum(meta$n_fragments),
                                         sum(filtered_meta$n_fragments),
                                         sum(meta$n_fragments) - sum(filtered_meta$n_fragments),
                                         sum(meta$n_unique),
                                         sum(filtered_meta$n_unique),
                                         sum(meta$n_unique) - sum(filtered_meta$n_unique)))
fragment_qc_stats$millions <- round(fragment_qc_stats$count / 1e6, 2)
fragment_qc_stats$percent <- round(fragment_qc_stats$count / fragment_qc_stats$count[1] * 100, 2)

qc_table(fragment_qc_stats)
```


#### 10x Metrics
```{r}
tenx_metrics <- data.frame(metric = names(metrics_summary),
                           values = round(unlist(metrics_summary[1,]), 4))

qc_table(tenx_metrics)
```

<a id="qc_plots"></a>

#### Plot QC Stats
```{r}
n_reads_hist <- qc_hist_plot(meta,
                             column = "n_unique",
                             name_x = "N Unique Fragments per Cell",
                             log_x = TRUE,
                             fill = "dodgerblue",
                             target = 2500,
                             y_max = 1000)
fralt_hist <- qc_frac_hist_plot(meta,
                                column = "fralt",
                                name_x = "Frac Reads in Altius Index (FRAlt)",
                                fill = "darkgreen",
                                target = fralt_cut,
                                y_max = 8000)
frip_hist <- qc_frac_hist_plot(meta,
                               column = "frip",
                               name_x = "Frac Reads in Peaks (FRIP)",
                               fill = "mediumorchid3",
                               target = frip_cut,
                                y_max = 5000)
fritss_hist <- qc_frac_hist_plot(meta,
                                 column = "fritss",
                                 name_x = "Frac Reads in TSS (FRITSS)",
                                 fill = "orangered",
                                 target = fritss_cut,
                                y_max = 5000)
plot_list <- list(n_reads_hist,
                  fralt_hist,
                  frip_hist,
                  fritss_hist)

cowplot::plot_grid(plotlist = plot_list,
                   nrow = 4, ncol = 1)
```

#### Pairwise scatters
```{r}
qc_scatter_plot(meta,
                column_x = "n_unique",
                name_x = "N Unique Fragments per Cell",
                column_y = "fralt",
                name_y = "Frac Fragments in Altius Index (FRAlt)",
                log_x = TRUE, log_y = FALSE, frac_y = TRUE,
                show_targets = FALSE,
                color = "darkgreen") +
  geom_vline(aes(xintercept = 2.5e3), linetype = "dashed", size = 0.2) +
  geom_hline(aes(yintercept = fralt_cut), linetype = "dashed", size = 0.2)
```

```{r}
qc_scatter_plot(meta,
                column_x = "frip",
                name_x = "Frac Reads in Peaks (FRIP)",
                column_y = "fritss",
                name_y = "Frac Reads in TSS (FRITSS)",
                log_x = FALSE, frac_x = TRUE, log_y = FALSE, frac_y = TRUE,
                show_targets = FALSE,
                color = "mediumorchid3") +
  geom_vline(aes(xintercept = fritss_cut), linetype = "dashed", size = 0.2) +
  geom_hline(aes(yintercept = frip_cut), linetype = "dashed", size = 0.2)
```

```{r}
qc_scatter_plot(meta,
                column_x = "peaks_count",
                name_x = "N Reads in Peaks (FRIP)",
                column_y = "tss_count",
                name_y = "N Reads in TSS (FRITSS)",
                log_x = TRUE, frac_x = FALSE, log_y = TRUE, frac_y = FALSE,
                show_targets = TRUE,
                color = "orangered")
```

#### Filtered QC Hists
```{r}
n_reads_hist <- qc_hist_plot(filtered_meta,
                             column = "n_unique",
                             name_x = "N Unique Fragments per Cell",
                             log_x = TRUE,
                             fill = "dodgerblue",
                             target = 2500,
                             y_max = 1000)
fralt_hist <- qc_frac_hist_plot(filtered_meta,
                                column = "fralt",
                                name_x = "Frac Reads in Altius Index (FRAlt)",
                                fill = "darkgreen",
                                target = fralt_cut,
                                y_max = 8000)
frip_hist <- qc_frac_hist_plot(filtered_meta,
                               column = "frip",
                               name_x = "Frac Reads in Peaks (FRIP)",
                               fill = "mediumorchid3",
                               target = frip_cut,
                                y_max = 5000)
fritss_hist <- qc_frac_hist_plot(filtered_meta,
                                 column = "fritss",
                                 name_x = "Frac Reads in TSS (FRITSS)",
                                 fill = "orangered",
                                 target = fritss_cut,
                                y_max = 5000)
plot_list <- list(n_reads_hist,
                  fralt_hist,
                  frip_hist,
                  fritss_hist)

cowplot::plot_grid(plotlist = plot_list,
                   nrow = 4, ncol = 1)
```

[Return to Contents](#contents)

<a id="json_out"></a>

### Write QC JSON

```{r Save QC JSON}
stm("No JSON available at this point.")
```

[Return to Contents](#contents)

<a id="session_info"></a>

## Session Information

```{r Session Info}
sessionInfo()
```

Total time elapsed
```{r Show Time}
end_time <- Sys.time()
diff_time <- end_time - start_time
time_message <- paste0("Elapsed Time: ", 
                       round(diff_time, 3),
                       " ", units(diff_time))
print(time_message)
stm(time_message)
stm("H5 metadata process complete.")
```

[Return to Contents](#contents)
